<!DOCTYPE html>
<html>

<head>
	<meta name="viewport"
		content="width=device-width, height=device-height, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- three.js library -->
	<script src='lib/three.min.js'></script>
	<script src="lib/ar.js"></script>
	<script src="lib/WebGL.js"></script>
	<script src="lib/GLTFLoader.js"></script>
	<!-- script for popup message -->
	<script src="lib/sweetalert2.all.min.js"></script>
	<!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support -->
	<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.js"></script>
	<title>AR Name Card</title>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>
	<script>
		//////////////////////////////////////////////////////////////////////////////////
		//		Init
		//////////////////////////////////////////////////////////////////////////////////

		//Error if not WebGL compatible
		if (WEBGL.isWebGLAvailable() === false) {
			document.body.appendChild(WEBGL.getWebGLErrorMessage());
		}

		// init renderer
		var renderer = new THREE.WebGLRenderer({
			antialias: true,
			autoResize: true,
			alpha: true
		});
		renderer.setClearColor(new THREE.Color('lightgrey'), 0);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.domElement.style.position = 'absolute'
		renderer.domElement.style.top = '0px'
		renderer.domElement.style.left = '0px'
		document.body.appendChild(renderer.domElement);

		// array of functions for the rendering loop
		var onRenderFcts = [];

		// init scene and camera

		var scene = new THREE.Scene();

		//////////////////////////////////////////////////////////////////////////////////
		//		Initialize a basic camera
		//////////////////////////////////////////////////////////////////////////////////

		// Create a camera
		var camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1500);
		scene.add(camera);

		var light = new THREE.AmbientLight(0xffffff); // soft white light
		light.intensity = 0.7;
		scene.add(light);

		spotLight = new THREE.SpotLight(0xffffff, 0.7);
		spotLight.position.set(-2, 3, 5);
		spotLight.angle = 0.5 * Math.PI / 4;
		spotLight.penumbra = 1;
		spotLight.decay = 2;
		spotLight.distance = 2000;
		scene.add(spotLight);

		////////////////////////////////////////////////////////////////////////////////
		//          handle arToolkitSource
		////////////////////////////////////////////////////////////////////////////////

		var arToolkitSource = new THREEx.ArToolkitSource({
			// to read from the webcam 
			sourceType: 'webcam'
		})

		arToolkitSource.init(function onReady() {
			onResize()
		})

		// handle resize
		window.addEventListener('resize', function () {
			onResize()
		})
		function onResize() {
			arToolkitSource.onResizeElement()
			arToolkitSource.copyElementSizeTo(renderer.domElement)
			if (arToolkitContext.arController !== null) {
				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
			}
		}
		////////////////////////////////////////////////////////////////////////////////
		//          initialize arToolkitContext
		////////////////////////////////////////////////////////////////////////////////


		// create atToolkitContext
		var arToolkitContext = new THREEx.ArToolkitContext({
			cameraParametersUrl: THREEx.ArToolkitContext.baseURL + '../data/data/camera_para.dat',
			detectionMode: 'mono',
			maxDetectionRate: 30,
			canvasWidth: 80 * 3,
			canvasHeight: 60 * 3,
		})
		// initialize it
		arToolkitContext.init(function onCompleted() {
			// copy projection matrix to camera
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		})

		// update artoolkit on every frame
		onRenderFcts.push(function () {
			if (arToolkitSource.ready === false) return
			arToolkitContext.update(arToolkitSource.domElement)
		})

		////////////////////////////////////////////////////////////////////////////////
		//          Create a ArMarkerControls
		////////////////////////////////////////////////////////////////////////////////

		var markerRoot = new THREE.Group
		scene.add(markerRoot)
		var artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
			type: 'pattern',
			patternUrl: 'marker/alphv.patt'
		})

		// build a smoothedControls
		var smoothedRoot = new THREE.Group()
		scene.add(smoothedRoot)
		var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
			lerpPosition: 0.4,
			lerpQuaternion: 0.3,
			lerpScale: 1,
		})
		onRenderFcts.push(function (delta) {
			smoothedControls.update(markerRoot);
		})

		//////////////////////////////////////////////////////////////////////////////////
		//		Add the objects in the scene
		//////////////////////////////////////////////////////////////////////////////////

		var arWorldRoot = smoothedRoot;

		var raycaster = new THREE.Raycaster();
		var mouse = new THREE.Vector2();

		var all = new THREE.Group();
		var mixer = null; // Animation mixer

		// Load 3D object
		var loader = new THREE.GLTFLoader();
		loader.load('content/scene.glb', function (gltf) {
			//add it to the scene
			all.add(gltf.scene);

			// Use scale 1 (model already correct size)
			gltf.scene.scale.set(1, 1, 1);

			// Center the model
			var bbox = new THREE.Box3().setFromObject(gltf.scene);
			var center = bbox.getCenter(new THREE.Vector3());
			var size = bbox.getSize(new THREE.Vector3());

			// Position: center horizontally, sit on ground
			gltf.scene.position.x = -center.x;
			gltf.scene.position.z = -center.z;
			gltf.scene.position.y = -bbox.min.y;

			// Setup animations
			if (gltf.animations && gltf.animations.length > 0) {
				mixer = new THREE.AnimationMixer(gltf.scene);
				gltf.animations.forEach(function (clip) {
					mixer.clipAction(clip).play();
				});
			}

		}, undefined, function (e) {
			console.error(e);
		});

		//link buttons - using custom icon images
		var geometry = new THREE.PlaneGeometry(0.3, 0.3);

		// Load icon textures from content/icon folder
		var webTexture = new THREE.TextureLoader().load('content/icon/web.png');
		var linkedinTexture = new THREE.TextureLoader().load('content/icon/linkedin.png');
		var gmailTexture = new THREE.TextureLoader().load('content/icon/gmail.png');
		var calendlyTexture = new THREE.TextureLoader().load('content/icon/calendly.png');

		// Create materials with the loaded textures
		var websiteMaterial = new THREE.MeshLambertMaterial({ map: webTexture, transparent: true });
		var linkedinMaterial = new THREE.MeshLambertMaterial({ map: linkedinTexture, transparent: true });
		var emailMaterial = new THREE.MeshLambertMaterial({ map: gmailTexture, transparent: true });
		var calendarMaterial = new THREE.MeshLambertMaterial({ map: calendlyTexture, transparent: true });

		var groupButton = new THREE.Group();

		var websiteBtn = new THREE.Mesh(geometry, websiteMaterial);
		websiteBtn.position.x = -0.6;
		groupButton.add(websiteBtn);

		var linkedinBtn = new THREE.Mesh(geometry, linkedinMaterial);
		linkedinBtn.position.x = -0.20;
		linkedinBtn.position.y = -0.10;
		groupButton.add(linkedinBtn);

		var emailBtn = new THREE.Mesh(geometry, emailMaterial);
		emailBtn.position.x = 0.20;
		emailBtn.position.y = -0.10;
		groupButton.add(emailBtn);

		var calendarBtn = new THREE.Mesh(geometry, calendarMaterial);
		calendarBtn.position.x = 0.6;
		groupButton.add(calendarBtn);

		groupButton.rotation.x = - Math.PI / 2;
		groupButton.position.z = 0.8;
		all.add(groupButton);

		all.scale.multiplyScalar(1.5);
		arWorldRoot.add(all);

		//////////////////////////////////////////////////////////////////////////////////
		//		render the whole thing on the page
		//////////////////////////////////////////////////////////////////////////////////

		// render the scene
		onRenderFcts.push(function (delta) {
			// Update animation mixer
			if (mixer) {
				mixer.update(delta);
			}
			renderer.render(scene, camera);
		})

		// run the rendering loop
		var lastTimeMsec = null
		requestAnimationFrame(function animate(nowMsec) {
			// keep looping
			requestAnimationFrame(animate);
			// measure time
			lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60
			var deltaMsec = Math.min(200, nowMsec - lastTimeMsec)
			lastTimeMsec = nowMsec
			// call each update function
			onRenderFcts.forEach(function (onRenderFct) {
				onRenderFct(deltaMsec / 1000, nowMsec / 1000)
			})
		})

		document.addEventListener('mousedown', onDocumentMouseDown, false);
		document.addEventListener('touchstart', onDocumentTouchStart, false);

		function onDocumentTouchStart(event) {

			event.preventDefault();

			event.clientX = event.touches[0].clientX;
			event.clientY = event.touches[0].clientY;
			onDocumentMouseDown(event);
		}

		function onDocumentMouseDown(event) {

			event.preventDefault();

			mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

			raycaster.setFromCamera(mouse, camera);

			var websiteIntersects = raycaster.intersectObjects([websiteBtn]);
			var linkedinIntersects = raycaster.intersectObjects([linkedinBtn]);
			var emailIntersects = raycaster.intersectObjects([emailBtn]);
			var calendarIntersects = raycaster.intersectObjects([calendarBtn]);

			// Same links as FallbackScene/SocialLinks3D
			if (websiteIntersects.length > 0) {
				window.open('https://alphv.com/', '_blank');
			} else if (linkedinIntersects.length > 0) {
				window.open('https://www.linkedin.com/in/daren-tan/', '_blank');
			} else if (emailIntersects.length > 0) {
				window.open('mailto:daren@alphv.com', '_blank');
			} else if (calendarIntersects.length > 0) {
				window.open('https://calendar.app.google/pkVAzzcZgxwSsZSe6', '_blank');
			}
		}

	</script>
</body>

</html>